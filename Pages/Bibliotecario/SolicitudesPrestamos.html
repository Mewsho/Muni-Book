<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Muni Book - Buscar Libros</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="icon" href="/Assets/Icon/book-svgrepo-com.svg" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-invoice-template@1.4.0/dist/index.js"></script>
    <script>


      // Falta Hacer el comprobande de la devolucion

      

      let parameters = {
        outputType: "save",
        returnJsPDFDocObject: true,
        fileName: "Invoice 2022",
        orientationLandscape: true,
        compress: true,
        logo: {
            src: "https://raw.githubusercontent.com/edisonneza/jspdf-invoice-template/demo/images/logo.png",
            width: 53.33, //aspect ratio = width/height
            height: 26.66,
            margin: {
                top: 0, //negative or positive num, from the current position
                left: 0 //negative or positive num, from the current position
            }
        },
        stamp: {
            inAllPages: true,
            src: "https://raw.githubusercontent.com/edisonneza/jspdf-invoice-template/demo/images/qr_code.jpg",
            width: 20, //aspect ratio = width/height
            height: 20,
            margin: {
                top: 0, //negative or positive num, from the current position
                left: 0 //negative or positive num, from the current position
            }
        },
        business: {
            name: "MuniBook",
            address: "Avenida Antonio Varas 880, Wakanda",
            phone: "+56943211234",
            email: "muni@book.com",
            website: "www.munibook.com",
        },
        contact: {
            label: "Solicitud de Préstamo:",
            name: "Client Name",// Cambiar
            address: "Albania, Tirane, Astir",// cambiar 
            phone: "(+355) 069 22 22 222", // cambiar
            email: "client@website.al", // cambiar
        },
        invoice: {
            label: "Invoice ID: ",
            num: "", // Cambiar
            invDate: "Payment Date: 01/01/2021 18:12", // Fecha de solicitud
            invGenDate: "",
            headerBorder: true,
            tableBodyBorder: true,
            header: [
            {
                title: "ID", 
                style: { 
                width: 40 
                } 
            }, 
            {
              title: "Codigo", 
              style: { 
              width: 20 
              } 
          }, 
            { 
                title: "Titulo",
                style: {
                width: 50
                } 
            }, 
            { 
                title: "Fecha Prestamo",
                style: {
                width: 60
                } 
            },
            { 
                title: "Fecha Devolucion",
                style: {
                width: 60
                } 
            }, 
            { title: "Tipo"},
            ],
            table: Array.from(Array(8), (item, index)=>([
                index + 1,
                "There are many variations ",
                "Lorem Ipsum is simply dummy text dummy text ",
                200.5,
                4.5,
                ""
            ])),
        additionalRows: [{
                }],
            
            invDescLabel: "Invoice Note",
            invDesc: "There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of text. All the Lorem Ipsum generators on the Internet tend to repeat predefined chunks as necessary.",
        },
        footer: {
            text: "Este comprobante fue creado en un computador y es valido sin firma ni estamapa.",
        },
        pageEnable: true,
        pageLabel: "Page ",
      }

      let listaForTableInvoice = []

      let isFirstUpdSolicitud = true
      let tipoLlamada = ""
      let tipoSolicitudForEjemplar = ""
      let SolicitudesPrestamos
      // Consigue todas las solicitudes y llama trtdSolicitudes
      async function cargarSolicitudesPrestamo(){
        const table = document.getElementById("tableBody")
        table.innerHTML=""
        let queryGetSolicitudesPrestamo = `
        query GetSolicitudPrestamosUsuarioPrestamos {
          getSolicitudPrestamosUsuarioPrestamos {
            id
            tipoSolicitud
            estadoSolicitud
            fechaSolicitud
            usuario {
              id
              nombres
              apellidos
              fechaSancion
              rut
            }
            prestamos {
              id
              tipoPrestamo
              fechaPrestamo
              fechaDevolucion
              fechaDevolucionReal
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryGetSolicitudesPrestamo
          }),
          success: function(response){
            let solicitudes = response.data.getSolicitudPrestamosUsuarioPrestamos
            solicitudes.forEach((solicitud) => trtdSolicitud(solicitud))
            $(".infoButton").click(function(){
              let idSolicitud = $(this).attr("solicitud")
              tipoLlamada = "BotonInfo"
              getInfoSolicitudPrestamos(idSolicitud)
            })
            $(".confirmarButton").click(function(){
              let idSolicitud = $(this).attr("solicitud")
              let rut = $(this).attr("rut")
              showModalConfirmar(idSolicitud,rut)
            })
            $(".rechazarButton").click(function(){
              let idSolicitud = $(this).attr("solicitud")
            })
          }
        })
      }

      // Añade los elementos a la tabla principal
      async function trtdSolicitud(solicitud){
        let estado = solicitud.estadoSolicitud
        let idSolicitud = solicitud.id
        let nombreUsuario = solicitud.usuario.nombres + " " + solicitud.usuario.apellidos
        let rutUsuario = solicitud.usuario.rut
        let tipoS = solicitud.tipoSolicitud
        let fechaS = new Date(solicitud.fechaSolicitud)
        fechaS = fechaS.toLocaleString()
        if (estado == 1){
          return
        }
        let strSolicitud = `
        <tr>
          <!-- id -->
          <td>${idSolicitud}</td>
          <!-- usuario -->
          <td>${nombreUsuario}</td>
          <!-- fechaSolicitud -->
          <td>${fechaS}</td>
          <!-- tipoSolicitud -->
          <td id="${idSolicitud}-tipo">${tipoS}</td>
          <!-- Botón Info para abrir el modal de más información (solo muestra los libros) -->
          <td>
            <button type="button" class="btn btn-info infoButton" id="${idSolicitud}-boton"
              solicitud="${idSolicitud}"
            >
              Info
            </button>
          </td>
          <td>
            <button type="button" class="btn btn-success confirmarButton" id="${idSolicitud}-boton-confirmar"
              solicitud="${idSolicitud}" rut="${rutUsuario}"
            >
              Confirmar
            </button>
          </td>
          <td>
            <button type="button" class="btn btn-danger rechazarButton" id="${idSolicitud}-boton-rechazar"
              solicitud="${idSolicitud}" 
            >
              Rechazar
            </button>
          </td>
        </tr>
        `

        let tabla = document.getElementById("tableBody")

        tabla.insertAdjacentHTML("beforeend",strSolicitud)
      }

      // Optiene la solicitud de prestamo y por cada prestamo llama a getEjemplarInfo()
      async function getInfoSolicitudPrestamos(idSolicitud){
        console.log(idSolicitud)
        const modalBody = document.getElementById("modalTableBody");
        modalBody.innerHTML= ""
        let queryGetSolicitudPrestamoByIdPrestamos = `
          query GetSolicitudPrestamoByIdPrestamos($getSolicitudPrestamoByIdPrestamosId: ID!) {
            getSolicitudPrestamoByIdPrestamos(id: $getSolicitudPrestamoByIdPrestamosId) {
              id
              tipoSolicitud
              estadoSolicitud
              fechaSolicitud
              prestamos {
                id
                tipoPrestamo
                fechaPrestamo
                fechaDevolucion
                fechaDevolucionReal
              }
            }
          }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryGetSolicitudPrestamoByIdPrestamos,
            variables : {
              getSolicitudPrestamoByIdPrestamosId: idSolicitud
            }
          }),
          success: function(response){
            console.log("getSolicitud")
            let prestamos = response.data.getSolicitudPrestamoByIdPrestamos.prestamos
            prestamos.forEach((prestamo) => getPrestamoInfo(prestamo))
            // Test comprobante

          }
        })
      }

      // Optiene la informacion del prestamo, llama a getInfoEjemplar con el ejemplar correspondiente
      // Muestra el modal si fue el boton de info
      async function getPrestamoInfo(prestamo){
        let id = prestamo.id
        let tipoPrestamo = prestamo.tipoPrestamo
        let queryPrestamoEjemplar = `
        query GetPrestamoByIdEjemplar($getPrestamoByIdEjemplarId: ID!) {
          getPrestamoByIdEjemplar(id: $getPrestamoByIdEjemplarId) {
            id
            tipoPrestamo
            ejemplar {
              id
              ubicacion
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryPrestamoEjemplar,
            variables : {
              getPrestamoByIdEjemplarId: id
            }
          }),
          success: function(response){
            let ejemplar = response.data.getPrestamoByIdEjemplar.ejemplar
            getInfoEjemplar(ejemplar, tipoPrestamo)
            if (tipoLlamada == "BotonInfo"){
              $('#infoModal').modal('toggle')
            } 
          }
        })
      }

      // Obtiene la info del ejemplar y si es del tipo info, rellena el infoModal
      // Si viene de confirmar revisa los inputs del modal si son los codigos correctos
      // si lo son llama a updEjemplar
      async function getInfoEjemplar(ejemplar, tipo){
        let id = ejemplar.id
        let queryEjemplar = `
        query GetEjemplarByIdDocumento($getEjemplarByIdDocumentoId2: ID!) {
          getEjemplarByIdDocumento(id: $getEjemplarByIdDocumentoId2) {
            id
            codigo
            estado
            estadoTexto
            ubicacion
            documento {
              titulo
              autor
              id
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryEjemplar,
            variables : {
              getEjemplarByIdDocumentoId2: id
            }
          }),
          success: function(response){
            if (tipoLlamada == "BotonInfo"){
              let ejemplar = response.data.getEjemplarByIdDocumento
              let titulo = ejemplar.documento.titulo
              let autor = ejemplar.documento.autor
              const modalBody = document.getElementById("modalTableBody");
              let strModalRow = `
              <tr>
                <td>${ejemplar.id}</td>
                <td>${ejemplar.codigo}</td>
                <td>${titulo}</td>
                <td>${autor}</td>
                <td>${ejemplar.ubicacion}</td>
              </tr>
              `
              modalBody.insertAdjacentHTML("beforeend",strModalRow)
            }
            else if(tipoLlamada == "ConfirmarSolicitud"){

              let inputs = document.getElementsByClassName("input-codigo")
              let listaTexto = []
              for (input of inputs){
                listaTexto.push(input.value)
              }
              console.log(listaTexto)

              let ejemplar = response.data.getEjemplarByIdDocumento
              let ejemplarCodigo = ejemplar.codigo
              console.log(ejemplarCodigo)
              if (!listaTexto.includes(ejemplarCodigo)){
                const mensajeDiv = document.getElementById("mensajeModal");
                mensajeDiv.style.display = "block";
                mensajeDiv.innerHTML =
                    '<div class="alert alert-danger">Codigo de Ejemplar Incorrecto</div>';
                  setTimeout(function () {
                    mensajeDiv.style.display = "none"; // Oculta el mensaje
                  }, 2000); 
                return
              }
              updEjemplar(ejemplar, tipo)
            }
          }
        })
      }

      // Mensaje de exito al terminar la solicitud
      function showSuccessMessage(){

        if (isFirstUpdSolicitud){
          isFirstUpdSolicitud = false
          const mensajeDiv = document.getElementById("mensajeTabla");
          mensajeDiv.style.display = "block";
          cargarSolicitudesPrestamo()
          mensajeDiv.innerHTML =
              '<div class="alert alert-danger">Solicitud Confirmada</div>';
          $('#modalConfirmacion').modal('toggle')
          setTimeout(function () {
            mensajeDiv.style.display = "none";
            isFirstUpdSolicitud = true
          }, 3000);
        }
      }



      // Muestra el modal de confirmar y modifica su interior segun lo requerido
      async function showModalConfirmar(idSolicitud, rut){
        let queryGetSolicitudPrestamoByIdPrestamos = `
        query GetSolicitudPrestamoByIdPrestamos($getSolicitudPrestamoByIdPrestamosId: ID!) {
          getSolicitudPrestamoByIdPrestamos(id: $getSolicitudPrestamoByIdPrestamosId) {
            id
            prestamos {
              id
              tipoPrestamo
              fechaPrestamo
              fechaDevolucion
              fechaDevolucionReal
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryGetSolicitudPrestamoByIdPrestamos,
            variables : {
              getSolicitudPrestamoByIdPrestamosId: idSolicitud
            }
          }),
          success: function(response){
            let prestamos = response.data.getSolicitudPrestamoByIdPrestamos.prestamos
            let cantPrestamos = prestamos.length
            let elemento = document.getElementById("modalConfirmacionEjemplares")
            elemento.innerHTML = '<label class="form-label">Codigo Ejemplar(es)</label>'
            for (let i = 0; i< cantPrestamos; i++){
              let strInput =`
              <input type="text" class="form-control mb-2 input-codigo" id="codigo${i}">
              `
              elemento.insertAdjacentHTML("beforeend",strInput)
            }
            let modal = document.getElementById("modalConfirmacion")
            modal.setAttribute("solicitud",idSolicitud)
            modal.setAttribute("rut",rut)
            $('#modalConfirmacion').modal('toggle')
          }
        })
      }

      // Llamada por el boton de confirmar solicitud
      // Revisa si el rut es correcto, y llama a getInfoSolicitudPrestamos
      async function confirmarSolicitud(){
        let rutReal = document.getElementById("modalConfirmacion").getAttribute("rut")
        let rutInput = document.getElementById("usuarioRutModal").value
        if (rutReal != rutInput){
          const mensajeDiv = document.getElementById("mensajeModal");
          mensajeDiv.style.display = "block";
          mensajeDiv.innerHTML =
            '<div class="alert alert-danger">RUT Equivocado</div>';
          setTimeout(function () {
            mensajeDiv.style.display = "none"; // Oculta el mensaje
          }, 2000); 
          console.log("RUT Equivocado")
          return
        }

        let modal = document.getElementById("modalConfirmacion")
        id = modal.getAttribute("solicitud")
        tipoLlamada = "ConfirmarSolicitud"
        getInfoSolicitudPrestamos(id)    
      }

      // Actualiza el ejemplar para estar en el estado de prestado
      async function updEjemplar(ejemplar,tipo){
        console.log(ejemplar,tipo) 
        
        let estadoInt = 0
        if (tipo == "Sala"){
          estadoInt = 2
        }
        else if(tipo == "Reserva"){
          estadoInt = 1
        }
        else if(tipo == "Domicilio"){
          estadoInt = 0
        }

        let queryUpdEjemplar= `
        mutation UpdEjemplar($updEjemplarId2: ID!, $updEjemplarInput3: EjemplarInput) {
          updEjemplar(id: $updEjemplarId2, input: $updEjemplarInput3) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryUpdEjemplar,
            variables : {
              updEjemplarId2: ejemplar.id,
              updEjemplarInput3: {
                codigo: ejemplar.codigo,
                estado: estadoInt,
                estadoTexto: tipo,
                ubicacion: ejemplar.ubicacion,
                documento: ejemplar.documento.id
              } 
            }
          }),
          success: function(response){
            console.log("Ejemplar Actualizado")
            updSolicitudPrestamo()
          }
        })
      
      }

      let firstUpdSolicitud = false
      // Actualiza la solicitud de prestamo para ser aprobada
      function updSolicitudPrestamo(){
        let modal = document.getElementById("modalConfirmacion")
        let idSolicitud = modal.getAttribute("solicitud")
        let queryUpdSolicitud = `
        mutation UpdSolicitudPrestamo($updSolicitudPrestamoId2: ID!, $updSolicitudPrestamoInput2: SolicitudPrestamoInput) {
          updSolicitudPrestamo(id: $updSolicitudPrestamoId2, input: $updSolicitudPrestamoInput2) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryUpdSolicitud,
            variables : {
              updSolicitudPrestamoId2: idSolicitud,
              updSolicitudPrestamoInput2: {
                estadoSolicitud: 1,
              } 
            }
          }),
          success: function(response){
            showSuccessMessage()
            getSolicitudToUpdPrestamo(idSolicitud)
          }
        })
      }

      
      async function getSolicitudToUpdPrestamo(id){
        let queryGetSolicitudPrestamoByIdPrestamosUsuarios = `
        query GetSolicitudPrestamoByIdUsuarioPrestamos($getSolicitudPrestamoByIdUsuarioPrestamosId: ID!) {
          getSolicitudPrestamoByIdUsuarioPrestamos(id: $getSolicitudPrestamoByIdUsuarioPrestamosId) {
            id
            tipoSolicitud
            estadoSolicitud
            fechaSolicitud
            usuario {
              id
              rut
              nombres
              apellidos
              direccion
              telefono
              activo
              codigo
              correo
              password
              tipoUsuario
              fechaSancion
            }
            prestamos {
              id
              tipoPrestamo
              fechaPrestamo
              fechaDevolucion
              fechaDevolucionReal
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryGetSolicitudPrestamoByIdPrestamosUsuarios,
            variables : {
              getSolicitudPrestamoByIdUsuarioPrestamosId: id
            }
          }),
          success: function(response){
            console.log("getSolicitudToUpdPrestamo")
            let solicitud = response.data.getSolicitudPrestamoByIdUsuarioPrestamos
            let prestamos = response.data.getSolicitudPrestamoByIdUsuarioPrestamos.prestamos
            let usuario = response.data.getSolicitudPrestamoByIdUsuarioPrestamos.usuario
            prestamos.forEach((prestamo) => getPrestamoEjemplarToUpdPrestamo(prestamo))
            // Test parametros
            
            setTimeout(function () {
              hacerComprobanteInicio(solicitud)
            }, 3000);
          }
        })
      }

      async function getPrestamoEjemplarToUpdPrestamo(prestamo){
        console.log("prevgetPrestamoEjemplarToUpdPrestamo")
        let queryPrestamoEjemplar = `
        query GetPrestamoByIdEjemplar($getPrestamoByIdEjemplarId3: ID!) {
          getPrestamoByIdEjemplar(id: $getPrestamoByIdEjemplarId3) {
            id
            tipoPrestamo
            ejemplar {
              id
              codigo
              estado
              estadoTexto
              ubicacion
            }
            fechaPrestamo
            fechaDevolucion
            fechaDevolucionReal
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryPrestamoEjemplar,
            variables : {
              getPrestamoByIdEjemplarId3: prestamo.id
            }
          }),
          success: function(response){
            console.log("postgetPrestamoEjemplarToUpdPrestamo")
            let ejemplar = response.data.getPrestamoByIdEjemplar.ejemplar
            let prestamo = response.data.getPrestamoByIdEjemplar
            updPrestamo(prestamo, ejemplar)
            
          }
        })
      }


      function addDays(date, days) {
        var result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      }

      function addHours(date, hours) {
        var result = new Date(date);
        result.setDate(result.getHours() + hours);
        return result;
      }

      async function updPrestamo(prestamo, ejemplar){
        console.log("UpdPrestamoInicio")
        let queryUpd = `
        mutation UpdPrestamo($updPrestamoId2: ID!, $updPrestamoInput3: PrestamoInput) {
          updPrestamo(id: $updPrestamoId2, input: $updPrestamoInput3) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `
        let codigoEjemplar = ejemplar.codigo // tipoDocumento-Documento-NEjemplar
        let tipoDocumentoCodigo = codigoEjemplar.split('-')[0]
        let fechaPrestamo = new Date(prestamo.fechaPrestamo)
        let tipoPrestamo = prestamo.tipoPrestamo
        let tiempoExtra 
        let fechaDev 

        if(tipoPrestamo == "Sala"){
          tiempoExtra = 4
          fechaDev = addHours(fechaPrestamo, tiempoExtra)
        }
        else if (tipoPrestamo == "Domicilio"){
          switch (tipoDocumentoCodigo){
            case "1": // Tecnico
              tiempoExtra = 7;
              break;
            case "2": // DVD
              tiempoExtra = 3;
              break;
            case "3": // Bray
              tiempoExtra = 2;
              break;          
            case "4": // CD
              tiempoExtra = 4;
              break;
            case "5": // Casete
              tiempoExtra = 4;
              break;
            case "6": // Religioso
              tiempoExtra = 7;
              break;
            case "7": // Academico
              tiempoExtra = 7;
              break;
            case "8": // Infantil
              tiempoExtra = 7;
              break;
            case "9": // Referencia
              tiempoExtra = 7;
              break;
            case "10": // Educacional
              tiempoExtra = 7;
              break;
            case "11": // Ficcion
              tiempoExtra = 7;
              break;
            case "12": // NoFiccion
              tiempoExtra = 7;
              break;
            case "13": // Comic/ Novela grafica
              tiempoExtra = 7;
              break;
          }

          fechaDev = addDays(fechaPrestamo, tiempoExtra)
        }


        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryUpd,
            variables : {
              updPrestamoId2: prestamo.id,
              updPrestamoInput3: {
                fechaDevolucion: fechaDev,
              }
            }
          }),
          success: function(response){
            console.log("UpdPrestamo Completado")
          }
        })

      }


      let contador = 0
      let contadorMaximo = 0
      function hacerComprobanteInicio(solicitud){
        contador = 0
        parameters.contact.name = solicitud.usuario.nombres + " " + solicitud.usuario.apellidos
        parameters.contact.address = solicitud.usuario.direccion
        parameters.contact.phone = `${solicitud.usuario.telefono}`
        parameters.contact.email = solicitud.usuario.correo
        parameters.invoice.label = `Invoice ID: ${solicitud.id}`
        parameters.invoice.invDate = solicitud.fechaSolicitud

        let tipo = solicitud.tipoSolicitud
        let prestamos = solicitud.prestamos
        contadorMaximo = prestamos.length
        prestamos.forEach((prestamo) => hacerComprobanteInter(prestamo))
        
        
        /*
        for (prestamo of prestamos){
          listaForTableInvoice.push([prestamo.id,"codigo"
          ,"Titulo",prestamo.fechaPrestamo.toLocaleString(), prestamo.fechaDevolucion.toLocaleString(), tipo])
        }
        parameters.invoice.table = listaForTableInvoice
        */


      }

      function hacerComprobanteInter(prestamo){
        let queryPrestamos = `
        query GetPrestamoByIdEjemplar($getPrestamoByIdEjemplarId3: ID!) {
          getPrestamoByIdEjemplar(id: $getPrestamoByIdEjemplarId3) {
            id
            tipoPrestamo
            ejemplar {
              id
              codigo
              estado
              estadoTexto
              ubicacion
            }
            fechaPrestamo
            fechaDevolucion
            fechaDevolucionReal
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryPrestamos,
            variables : {
              getPrestamoByIdEjemplarId3: prestamo.id
            }
          }),
          success: function(response){
            let prest = response.data.getPrestamoByIdEjemplar
            obtenerEjemplarForComprobante(prest)
          }
        })
      }


      function obtenerEjemplarForComprobante(prestamo){
        let queryEjemplar = `
        query GetEjemplarByIdDocumento($getEjemplarByIdDocumentoId2: ID!) {
          getEjemplarByIdDocumento(id: $getEjemplarByIdDocumentoId2) {
            id
            codigo
            estado
            estadoTexto
            ubicacion
            documento {
              titulo
              autor
              id
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryEjemplar,
            variables : {
              getEjemplarByIdDocumentoId2: prestamo.ejemplar.id
            }
          }),
          success: function(response){
            
            let ejemplar = response.data.getEjemplarByIdDocumento
            console.log(prestamo,ejemplar)
            let lista = [
              prestamo.id, ejemplar.codigo, ejemplar.documento.titulo,
              prestamo.fechaPrestamo.toLocaleString(), prestamo.fechaDevolucion.toLocaleString(), prestamo.tipoPrestamo
            ]
            listaForTableInvoice.push(lista)
            contador +=1
            if (contador == contadorMaximo){
              parameters.invoice.table = listaForTableInvoice
              test()
            }
          }
        })
      }

    </script>
    <style>
      h1 {
        font-family: "Times New Roman", Times, serif;
        font-size: 300%;
      }

      h2 {
        font-family: "Times New Roman", Times, serif;
      }

      body {
        font-family: "Times New Roman", Times, serif;
        min-height: 100vh; /* Ocupa el 100% de la altura de la ventana */
        display: flex;
        flex-direction: column;
        background-color: #c5c3b8;
      }

      .container {
        flex-grow: 1; /* Se expande para ocupar el espacio disponible */
      }

      .hero-title {
        margin-top: 100px;
        text-align: center;
        font-size: 1000%;
      }

      .hero-subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
      }

      .list-container {
        background-color: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: auto;
      }

      .table th,
      .table td {
        text-align: center;
        vertical-align: middle;
      }

      .btn-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      #mensaje {
        display: none;
        justify-content: center; /* Centra el contenido del div */
        align-items: center; /* Centra el contenido verticalmente */
        text-align: center; /* Alinea el texto al centro */
        margin-top: 20px; /* Margen superior */
      }

      footer {
        background-color: #000;
        color: #fff;
        padding: 20px 0;
      }

      .hero-section {
        background-color: #f8f9fa;
        padding: 4rem 0;
      }

      .features-section {
        padding: 4rem 0;
      }

      .display-4 {
        font-size: 1000%;
        font-family: "Times New Roman", Times, serif;
      }

      .nav-link {
        align-items: center;
        font-family: "Times New Roman", Times, serif;
        align-content: center;
        text-align: end;
        color: #efeae4;
      }
      /* para link en footer*/
      .footer-link {
        color: inherit;
        text-decoration: none;
        cursor: pointer;
      }
      /* y esta cambia el cursor */
      .footer-link:hover {
        text-decoration: underline;
        color: inherit;
      }
      .navbar-toggler-icon {
        background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3E%3Cpath stroke='white' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E") !important;
      }
      .navbar-toggler {
        border-color: white; /* Cambia el borde del toggler a blanco */
      }
    </style>
  </head>
  <body onload="cargarSolicitudesPrestamo()">
    <!-- Header Section -->
    <nav class="navbar navbar-expand-lg bg-dark navbar-light">
      <div class="container">
        <a class="navbar-brand" href="/Pages/index.html">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            fill="white"
            class="bi bi-book"
            viewBox="0 0 16 16"
          >
            <path
              d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"
            />
          </svg>
        </a>
        <!-- Botones del navbar-->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="..//catalogo.html">Catalogo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#servicios">Servicios</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contact">Contacto</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="..//User/solicitudDePrestamo.html"><i class="fa-solid fa-cart-shopping"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Title and Subtitle -->
    <div class="container">
      <h1 class="hero-title">Muni Book</h1>
      <p class="hero-subtitle">bibliotecario1</p>
    </div>

    <!-- list Section -->
    <div class="container mt-5">
      <div class="list-container" style="border: 3px solid #000">
        <h2 class="text-center mb-4">Solicitudes de Préstamos</h2>

        <!-- Lista de solicitudes en formato de tabla -->
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>ID Solicitud</th>
              <th>Nombre de Usuario</th>
              <th>Fecha Solicitada</th>
              <th>Tipo Solicitud</th>
              <th>Ver Más</th>
              <th>Confirmar</th>
              <th>Rechazar</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            
          </tbody>
        </table>
        <div id="mensajeTabla" class="mt-3" style="display: none"></div>
      </div>
      <div>
        <button type="button" class="btn btn-success" onclick="test()">TEST</button>
      </div>
    </div>


    <!-- Modal de Confirmacion -->
    <div class="modal fade" id="modalConfirmacion" solicitud="" rut="" tabindex="-1"> 
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar Solicitud?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="usuarioRutModal" class="form-label">RUT</label>
                <input type="text" class="form-control" id="usuarioRutModal" aria-describedby="rutHelp">
              </div>
              <div class="mb-3" id="modalConfirmacionEjemplares">
                <label class="form-label">Codigo Ejemplar(es)</label>
              </div>
            </form>
            <div id="mensajeModal" class="container mt-3" style="display: none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="confirmarSolicitud()">Confirmar</button>         
          </div>
        </div>
      </div>
    </div>


    <div>
        <!-- Footer -->
      <footer class="bg-dark text-light py-4">
        <div class="container">
          <div class="row">
            <div class="col-md-3 mb-3">
              <h5>Muni Book</h5>
              <ul class="list-unstyled">
                <li>Tu libreria de confianza</li>
                <li>Siguenos en redes!</li>
              </ul>
            </div>
            <div class="col-md-3 mb-3">
              <h5>Explorar</h5>
              <ul class="list-unstyled">
                <li><a href="catalogo.html"> Catalogo </a></li>
                <li><a onclick="loginButton()">Inicia Sesion</a></li>
              </ul>
            </div>
            <div class="col-md-3 mb-3">
              <h5>Recursos</h5>
              <ul class="list-unstyled">
                <li>Sobre nosotros</li>
                <li>Contactanos</li>
                <li>Atencion al cliente</li>
              </ul>
            </div>
            <div class="col-md-3 mb-3">
              <h5>Siguenos</h5>
              <div class="d-flex">
                <a href="#" class="text-light me-2">
                  <i class="fa-brands fa-instagram"></i>
                </a>
                <a href="#" class="text-light me-2">
                  <i class="fa-brands fa-facebook"></i>
                </a>
                <a href="#" class="text-light me-2">
                  <i class="fa-brands fa-x-twitter"></i>
                </a>
                <a href="#" class="text-light">
                  <i class="fa-brands fa-youtube"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
    

        <!-- Modal de más información -->
    <div
      class="modal fade"
      id="infoModal"
      tabindex="-1"
      aria-labelledby="infoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">
              Información de Préstamos
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Codigo</th>
                  <th>Nombre del Libro</th>
                  <th>Autor</th>
                  <th>Ubicación</th>
                </tr>
              </thead>
              <tbody id="modalTableBody">

              </tbody>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Footer -->
    <footer class="bg-dark text-custom py-4 mt-4">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-3">
            <h5>Muni Book</h5>
            <ul class="list-unstyled">
              <li>Tu libreria de confianza</li>
              <li>Siguenos en redes!</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Explorar</h5>
            <ul class="list-unstyled">
              <li>
                <a class="footer-link" href="catalogo.html"> Catalogo </a>
              </li>
              <a class="footer-link" onclick="loginButton()">Inicia Sesion</a>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Recursos</h5>
            <ul class="list-unstyled">
              <li>
                <a class="footer-link" href="ContactoMas.html"
                  >Sobre nosotros</a
                >
              </li>
              <li>
                <a class="footer-link" href="#">Contactanos</a>
              </li>
              <li>
                <a class="footer-link" href="#">Atencion al cliente</a>
              </li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Siguenos</h5>
            <div class="d-flex">
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-instagram"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-facebook"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-x-twitter"></i>
              </a>
              <a href="#" class="text-light">
                <i class="fa-brands fa-youtube"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>
<<<<<<< Updated upstream


    <script>
      
      async function test(){

        
        const { jsPDF } = window.jspdf;
        //jsPDFInvoiceTemplate.default( parameters );

        var pdfCreated = jsPDFInvoiceTemplate.default({ ...parameters });
        pdfCreated.jsPDFDocObject.save(); //or .output('<outputTypeHere>');


      }
    </script>
=======
>>>>>>> Stashed changes
  </body>
</html>
