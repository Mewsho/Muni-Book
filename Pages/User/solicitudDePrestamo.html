<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Muni Book - solisitud Libros</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans", sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #c5c3b8;
      }
      .container {
        flex-grow: 1;
      }
      .cart-section {
        margin-top: 3%;
        margin-bottom: 5%;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 10px;
        background-color: #f7f6f5;
      }
      /* Botón de confirmación */
      .confirm-btn {
        background-color: #28a745;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
      }

      .confirm-btn:hover {
        background-color: #218838;
      }
      /* Botón de eliminar libro */
      .remove-btn {
        color: #ff4d4d;
        border: none;
        background-color: transparent;
      }

      .remove-btn:hover {
        color: #fff;
        background-color: #ff4d4d;
        border-radius: 4px;
      }
      footer {
        background-color: #000;
        color: #fff;
        padding: 20px 0;
      }

      .footer-link {
        color: inherit;
        text-decoration: none;
        cursor: pointer;
      }

      .footer-link:hover {
        text-decoration: underline;
        color: inherit;
      }

      .hero-section {
        background-color: #f8f9fa;
        padding: 4rem 0;
      }

      .features-section {
        padding: 4rem 0;
      }

      .display-4 {
        font-size: 1000%;
        font-family: "Noto Sans", sans-serif;
      }

      .nav-link {
        align-items: center;
        font-family: "Noto Sans", sans-serif;
        align-content: center;
        text-align: end;
      }
    </style>
    <script>
      let PrestamosGlobal = [];
      let SolicitudPrestamosGlobal = "";
      let IdUsuarioGlobal = "";
      let IdEjemplaresGlobales = [];

      function ActualizarFechaPrestamos(
        idActual,
        valor,
        fechaPrestamo,
        fechaDevolucion,
        index
      ) {
        let listaAuxiliar1 = [];

        for (variable of IdEjemplaresGlobales) {
          listaAuxiliar1.push(variable.id);
        }

        console.log(idActual);
        console.log(index);
        let queryActualizarPrestamos = `
          mutation UpdPrestamo($updPrestamoId: ID!, $input: PrestamoInput) {
            updPrestamo(id: $updPrestamoId, input: $input) {
              statusCode
              body
              errorCode
              descriptionError
            }
          }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryActualizarPrestamos,
            variables: {
              updPrestamoId: idActual,
              input: {
                fechaPrestamo: fechaPrestamo,

                fechaDevolucion: fechaDevolucion,

                tipoPrestamo: valor,
                ejemplar: listaAuxiliar1[index],
              },
            },
          }),
          success: function (response) {},
        });
      }

      function ObtenerEleccion() {
        let radio1 = document.getElementsByClassName("form-check-input");
        let fechaPrestamo = null;
        let fechaDevolucion = null;

        let valor;
        for (let button of radio1) {
          if (button.checked) {
            valor = button.value;
          }
        }

        if (valor == "sala") {
          fechaPrestamo = new Date();
          fechaDevolucion = new Date();
          fechaDevolucion.setHours(fechaDevolucion.getHours() + 3);
        }

        if (valor == "domicilio") {
          fechaPrestamo = new Date();
          fechaDevolucion = new Date();
          fechaDevolucion.setDate(fechaDevolucion.getDate() + 14);
        }

        if (valor == "reserve") {
          fechaPrestamo = new Date(
            document.getElementById("fechaPrestamo").value
          );
          fechaDevolucion = new Date(
            document.getElementById("fechaDevolucion").value
          );
        }

        let listaAuxiliar = [];

        for (variable of PrestamosGlobal) {
          listaAuxiliar.push(variable.id);
        }

        console.log(IdEjemplaresGlobales);

        let queryActualizarSolicitudPrestamo = `
          mutation UpdSolicitudPrestamo($updSolicitudPrestamoId: ID!, $input: SolicitudPrestamoInput) {
            updSolicitudPrestamo(id: $updSolicitudPrestamoId, input: $input) {
              statusCode
              body
              errorCode
              descriptionError
            }
          }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryActualizarSolicitudPrestamo,
            variables: {
              updSolicitudPrestamoId: SolicitudPrestamosGlobal,
              input: {
                fechaSolicitud: fechaPrestamo,
                prestamos: listaAuxiliar,
                tipoSolicitud: valor,
                usuario: IdUsuarioGlobal,
              },
            },
          }),
          success: function (response) {
            listaAuxiliar.forEach((id_prestamo, index) =>
              ActualizarFechaPrestamos(
                id_prestamo,
                valor,
                fechaPrestamo,
                fechaDevolucion,
                index
              )
            );
          },
        });
      }

      function cargarPrestamo12(prestamo) {
        let elemento = document.getElementById(prestamo.titulo);
        if (elemento == null) {
          let strPrestamo = `
            <li class="list-group-item d-flex justify-content-between align-items-center" id="${prestamo.titulo}">
              ${prestamo.titulo}
              <div>
                <span id="cantidad-${prestamo.titulo}" class="mx-2">1</span>
              </div>
            </li>
          `;
          let listaCarrito = document.getElementById("listaPrestamos");
          listaCarrito.insertAdjacentHTML("beforeend", strPrestamo);
        } else {
          let cantidadElemento = document.getElementById(
            `cantidad-${prestamo.titulo}`
          );
          let valorActual = parseInt(cantidadElemento.innerHTML, 10);
          cantidadElemento.innerHTML = valorActual + 1;
          console.log(cantidadElemento, valorActual);
        }
      }

      function updateQuantity(id, cantidad) {
        let cantidadElemento = document.getElementById(`cantidad-${id}`);
        let valorActual = parseInt(cantidadElemento.innerHTML, 10);
        let nuevoValor = valorActual + cantidad;
        if (nuevoValor >= 1) {
          // Evita que la cantidad sea menor que 1
          cantidadElemento.innerHTML = nuevoValor;
        }
      }

      function ObtenerIdDocumentoOfEjemplar(ejemplar) {
        let idEjemplar = ejemplar.id;
        let queryEjemplares = `
          query GetEjemplarByIdDocumento($getEjemplarByIdDocumentoId: ID!) {
            getEjemplarByIdDocumento(id: $getEjemplarByIdDocumentoId) {
              documento {
                titulo
                autor
                editorial
              }
            }
          }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryEjemplares,
            variables: {
              getEjemplarByIdDocumentoId: idEjemplar,
            },
          }),
          success: function (response) {
            let documentoActual =
              response.data.getEjemplarByIdDocumento.documento;
            cargarPrestamo12(documentoActual);
          },
        });
      }

      function ObtenerIdEjemplaresofPrestamos(prestamo) {
        let idPrestamo = prestamo.id;
        let queryPrestamos = `
          query GetPrestamoById($getPrestamoByIdEjemplarId: ID!) {
            getPrestamoByIdEjemplar(id: $getPrestamoByIdEjemplarId) {
              ejemplar {
                id
              }
            }
          }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryPrestamos,
            variables: {
              getPrestamoByIdEjemplarId: idPrestamo,
            },
          }),
          success: function (response) {
            let EjemplarActual = response.data.getPrestamoByIdEjemplar.ejemplar;
            IdEjemplaresGlobales.push(EjemplarActual);
            ObtenerIdDocumentoOfEjemplar(EjemplarActual);
          },
        });
      }

      async function ObtenerSolicitudPrestamos() {
        const cookieValue = document.cookie
          .split("; ")
          .find((row) => row.startsWith(`id=`))
          ?.split("=")[1];
        let idDeUsuario = cookieValue;

        let querySolicitudPrestamos = `
          query GetSolicitudPrestamoNoActivaByUsuarioId($usuarioId: ID!) {
          getSolicitudPrestamoNoActivaByUsuarioId(usuarioID: $usuarioId) {
            id
            tipoSolicitud
            estadoSolicitud
            fechaSolicitud
            usuario {
              id
              rut
              nombres
              apellidos
              direccion
              telefono
              activo
              codigo
              correo
              password
              tipoUsuario
              fechaSancion
            }
            prestamos {
              id
              tipoPrestamo
              fechaPrestamo
              fechaDevolucion
              fechaDevolucionReal
            }
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: querySolicitudPrestamos,
            variables: {
              usuarioId: idDeUsuario,
            },
          }),
          success: function (response) {
            let arrayPrestamos =
              response.data.getSolicitudPrestamoNoActivaByUsuarioId.prestamos;
            let solicitudPrestamoActualId =
              response.data.getSolicitudPrestamoNoActivaByUsuarioId.id;
            let cantidadTotalLibros = (document.getElementById(
              "cantidadLibros"
            ).value = arrayPrestamos.length);
            arrayPrestamos.forEach(ObtenerIdEjemplaresofPrestamos);
            SolicitudPrestamosGlobal = solicitudPrestamoActualId;
            PrestamosGlobal = arrayPrestamos;
            IdUsuarioGlobal = idDeUsuario;
          },
        });
      }
    </script>
  </head>
  <body onload="ObtenerSolicitudPrestamos()">
    <!-- Header Section -->

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="/Pages/index.html">
          <svg
            width="30"
            height="30"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect width="24" height="24" fill="white" />
            <path d="M4 4H20V20H4V4Z" stroke="black" stroke-width="2" />
            <path d="M8 8H16V16H8V8Z" stroke="black" stroke-width="2" />
          </svg>
        </a>
        <!-- Botones del navbar-->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="..//catalogo.html">Catalogo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#servicios">Servicios</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#contact">Contacto</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="..//User/solicitudDePrestamo.html"
                ><i class="fa-solid fa-cart-shopping"></i
              ></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Shopping Cart Section -->
    <div class="container cart-section">
      <div class="row">
        <!-- Lista de libros (span 8) -->
        <div class="col-md-8">
          <h3>Lista de Libros</h3>
          <ul class="list-group mb-3" id="listaPrestamos"></ul>
        </div>

        <!-- Opciones de préstamo y detalles (span 4) -->
        <div class="col-md-4">
          <h3>Detalles del Prestamo</h3>

          <div class="mb-3">
            <label for="cantidadLibros" class="form-label"
              >Cantidad Total de Libros</label
            >
            <input
              type="number"
              class="form-control"
              id="cantidadLibros"
              placeholder="0"
              readonly
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Tipo de Prestamo</label>
            <div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="tipoPrestamo"
                  id="prestamoSala"
                  value="Sala"
                />
                <label class="form-check-label" for="prestamoSala">
                  Prestamo en Sala
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="tipoPrestamo"
                  id="prestamoDomicilio"
                  value="Domicilio"
                />
                <label class="form-check-label" for="prestamoDomicilio">
                  Prestamo a Domicilio
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="tipoPrestamo"
                  id="reserve"
                  value="Reserva"
                  onclick="toggleDateBox(true)"
                />
                <label class="form-check-label" for="reserve">Reserva</label>
              </div>
            </div>
          </div>

          <!-- fecha prestamo -->
          <div class="mb-3" id="fechaPrestamoContainer" style="display: none">
            <label for="fechaPrestamo" class="form-label"
              >Fecha de Prestamo</label
            >
            <input
              type="datetime-local"
              class="form-control"
              id="fechaPrestamo"
              onchange="calcularFechaDevolucion()"
            />
          </div>
          <button
            class="btn btn-success w-100 mt-3"
            onclick="ObtenerEleccion()"
          >
            Confirmar solicitud
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación para eliminar libro -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">
              Eliminar Libro
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            ¿Está seguro de que desea eliminar este libro de la lista?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirmDeleteButton"
              data-bs-dismiss="modal"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-3">
            <h5>Muni Book</h5>
            <ul class="list-unstyled">
              <li>Tu libreria de confianza</li>
              <li>Siguenos en redes!</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Explorar</h5>
            <ul class="list-unstyled">
              <li>
                <a class="footer-link" href="/Pages/catalogo.html">
                  Catalogo
                </a>
              </li>

              <a class="footer-link" onclick="loginButton()">Inicia Sesion</a>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Recursos</h5>
            <ul class="list-unstyled">
              <li>
                <a class="footer-link" href="/Pages/ContactoMas.html">
                  Sobre nosotros
                </a>
              </li>
              <li>
                <a class="footer-link" href="#">Contactanos</a>
              </li>
              <li>
                <a class="footer-link" href="#">Atencion al cliente</a>
              </li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Siguenos</h5>
            <div class="d-flex">
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-instagram"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-facebook"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-x-twitter"></i>
              </a>
              <a href="#" class="text-light">
                <i class="fa-brands fa-youtube"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script>
      // Función para calcular la fecha de devolución, aproximadamente 2 semanas después de la fecha de préstamo
      function calcularFechaDevolucion() {
        const fechaPrestamo = new Date(
          document.getElementById("fechaPrestamo").value
        );

        if (fechaPrestamo) {
          fechaPrestamo.setDate(fechaPrestamo.getDate() + 14); // Añadir tiempo estimado (14 días)
          // Formato ISO (YYYY-MM-DD)
          document.getElementById("fechaDevolucion").value = fechaPrestamo
            .toISOString()
            .split("T")[0];
        }
      }

      // Función para confirmar la reserva (puedes agregar la lógica que desees)
      function confirmarSolisitud() {
        alert("Reserva confirmada. ¡Gracias por utilizar nuestro servicio!");
      }

      // Función para mostrar u ocultar los cuadros de fecha
      function toggleDateBox(show) {
        document.getElementById("fechaPrestamoContainer").style.display = show
          ? "block"
          : "none";
      }

      // Configurar el evento para mostrar/ocultar los cuadros de fecha según el tipo de préstamo
      document
        .querySelectorAll('input[name="tipoPrestamo"]')
        .forEach((radio) => {
          radio.addEventListener("change", function () {
            // Mostrar las fechas solo si el valor seleccionado es "reserve"
            toggleDateBox(this.value === "Reserva");
          });
        });
    </script>
  </body>
</html>
