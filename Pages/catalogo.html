<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="/Assets/Icon/book-svgrepo-com.svg">

    <title>MuniBook</title>
    
    <script>


      
      // Obtencion de cookies y cambios asociados
      function aplicarVersionUsuario(){}

      function aplicarVersionBibliotecario(){console.log()}

      function aplicarVersionNotUsuario(){}
    
      function aplicarVersionAdministrador(){}

      function checkCookieExistence(name){
        console.log(document.cookie)
        if(
          document.cookie.split(";").some((item) => item.trim().startsWith(`${name}=`))
        ){
          let tipoCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith(`tipo=`))
          ?.split("=")[1];
  
          switch (tipoCookie) {
            case 0:
              aplicarVersionUsuario()
              console.log("Usuario")
              break;
            case 1:
              aplicarVersionBibliotecario()
              console.log("Bibliotecario")
              break;
            case 2:
              aplicarVersionAdministrador()
              console.log("Administrador")
              break;
            /*  
            default:
              aplicarVersionNotUsuario()
              console.log(tipoCookie)
              console.log("NotUsuario")
              */
          }
        }
        else{
          aplicarVersionNotUsuario()
          console.log("NotUsuario")
        }
      }

      // form select de tipo y categoria
      let optionFormSelectTipo = ['<option value="">Selecciona Tipo Documento</option>']
      function optionTipo(item){
        optionFormSelectTipo.push('<option value="'+item.id+'">'+item.tipo+'</option>')
      }

      let optionFormSelectCategoria = ['<option value="">Selecciona Categoria</option>']
      function optionCategoria(item){
        optionFormSelectCategoria.push('<option value="'+item.id+'">'+item.categoria+'</option>')
      }
      // Funciones para optener la lista de tipo y categoria
      function cargarTipo(){
        let queryTipo = `
        query GetTipoDocumentos {
          getTipoDocumentos {
            id
            tipo
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryTipo,
          }),
          success: function(response){
            response.data.getTipoDocumentos.forEach(optionTipo)
            document.getElementById("formSelectTipo").innerHTML = optionFormSelectTipo.join("")
          }
        })
      }

      function cargarCategoria(){
        let queryCategoria = `
        query GetCategoriaDocumentos {
          getCategoriaDocumentos {
            id
            categoria
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryCategoria,
          }),
          success: function(response){
            response.data.getCategoriaDocumentos.forEach(optionCategoria)
            document.getElementById("formSelectCategoria").innerHTML = optionFormSelectCategoria.join("")
          }
        })
      }



      function aplicarCambiosCard(){
        if(
          document.cookie.split(";").some((item) => item.trim().startsWith(`tipo=`))
        ){
          let tipoCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith(`tipo=`))
          ?.split("=")[1];

          if (tipoCookie == 2){
            let inputGroupList = document.getElementsByClassName("input-group")
            for (inputGroup of inputGroupList){
              inputGroup.classList.add("d-none")
            }
          }
        }
      }

      let cantEjemplaresDisponible = 0
      let cantEjemplaresSala = 0
      // Obtener los ejemplares y crear el inner html
      function getEjemplares(documentoId, estado, estadoTexto){
        console.log("Obteniendo Ejemplares")
        let queryCantEjemplares = `
        query Query($documentoId: ID!, $estado: Int) {
          getCantEjemplaresByDocumentoAndEstado(documentoId: $documentoId, estado: $estado)
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryCantEjemplares,
            variables: {
              documentoId: documentoId,
              estado: estado
            }
          }),
          success: function(response){
            console.log("Ejemplares obtenidos")
            let cant = response.data.getCantEjemplaresByDocumentoAndEstado
            if (estado == 3){
              cantEjemplaresDisponible = response.data.getCantEjemplaresByDocumentoAndEstado
              let strInputGroup = `
              <button class="btn btn-outline-secondary btn-number-${documentoId}" type="button" id="${documentoId}-button-minus" documentId="${documentoId}" data-type="minus">-</button>
              <input type="text" class="form-control input-number" value="0" min="0" max="${cantEjemplaresDisponible}" id="${documentoId}-input">
              <button class="btn btn-outline-secondary btn-number-${documentoId}" type="button" id="${documentoId}-button-plus" documentId="${documentoId}" data-type="plus">+</button>
              `
              document.getElementById(`${documentoId}-inputGroup`).innerHTML = strInputGroup

              $(`.btn-number-${documentoId}`).click(function(){
                let tipo = $(this).attr("data-type")
                let documentId = $(this).attr("documentId");
                let input = $(`#${documentoId}-input`);
                let currentValue = parseInt(input.val());
                if(!isNaN(currentValue)){
                  if (tipo == "minus"){
                    if(currentValue > input.attr('min')) {
                      input.val(currentValue - 1).change();
                    } 
                    if(parseInt(input.val()) == input.attr('min')) {
                      $(this).attr('disabled', false);
                    }
                  }
                  else {
                    if(currentValue < input.attr('max')) {
                      input.val(currentValue + 1).change();
                    }
                    if(parseInt(input.val()) == input.attr('max')) {
                        $(this).attr('disabled', false);
                    }
                  }
                }
                else {
                  input.val(0)
                }
              });
    
            }
            if (estado == 2){
              cantEjemplaresSala = response.data.getCantEjemplaresByDocumentoAndEstado
            }
            document.getElementById(`${documentoId}.${estadoTexto}`).innerHTML = `${estadoTexto}: ${cant}`
          }
        })
      }

      // Definir la card para cada elemento del catalogo, obteniendo los ejemplares y preparando la informacion
      let listCardDocumentos = []
      function cardDocumentos(item){
        let listCategoriaDocumentosId = []
        let listCategoriaDocumentosNombre = []
        
        for (categoria of item.categoriaDocumento){
          listCategoriaDocumentosId.push(categoria.id)
          listCategoriaDocumentosNombre.push(categoria.categoria)
        }

        getEjemplares(item.id, 3, "Disponible")
        getEjemplares(item.id, 2, "En Sala")
        
        
        let stringCard = `
        <div class="col-md-4 mb-4">
          <div class="card" id=${item.id} categoria=${listCategoriaDocumentosId} tipoDocumento=${item.tipoDocumento.id}>
              <div class="card-body">
                <h5 class="card-title">${item.titulo}</h5>
                <p class="card-text">${item.autor}, ${item.anioSalida}, ${item.editorial}, ${item.tipoDocumento.tipo},</p>
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" 
                data-bs-target="#${item.id}.collapse">
                  Ver más información</button>
                <div class="collapse" id="${item.id}.collapse">
                  <div class="container my-3">
                    <p class="card-text my-1">${item.edicion}a Edición</p>
                    <p class="card-text my-1">Categorias: ${listCategoriaDocumentosNombre.toString()}</p>
                    <p class="card-text my-1" id="${item.id}.Disponible">Disponible: </p>
                    <p class="card-text my-1" id="${item.id}.En Sala">Sala: </p>
                    <div class="input-group my-1" id="${item.id}-inputGroup">
                      
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
        `
        listCardDocumentos.push(stringCard)
      }

      // Cargar documentos inicial
      function cargarDocumentos(){
        let queryDocumentos = `
        query GetNDocumentos($numero: Int) {
          getNDocumentos(numero: $numero) {
            id
            titulo
            autor
            editorial
            anioSalida
            edicion
            codigo
            tipoDocumento {
              id
              tipo
            }
            categoriaDocumento {
              id
              categoria
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryDocumentos,
            variables: {
              numero: 100
            }
          }),
          success: function(response){
            response.data.getNDocumentos.forEach(cardDocumentos)
            document.getElementById("catalogContainer").innerHTML = listCardDocumentos.join("")
            console.log("card agregadas")
            aplicarCambiosCard()
            
          }
        })
      }
      // Llamar todas las cosas
      function cargarTipoCategoriasDocumentos(){
        cargarTipo()
        cargarCategoria()
        cargarDocumentos()
        checkCookieExistence("tipo")
      }

      // La funcion para el query con los filtros
      function getDocumentosByTituloAndAutorAndTipoAndCategoria(){
        listCardDocumentos = []
        let title = document.getElementById("searchBarTitle").value
        let aut = document.getElementById("searchBarAuthor").value
        let tipo = document.getElementById("formSelectTipo").value
        let categoria = document.getElementById("formSelectCategoria").value
        
        if (tipo == ""){
          tipo = null
        }
        if (categoria == ""){
          categoria = null
        }
        console.log(title, aut, tipo, categoria)

        let queryDocumentos = `
        query GetDocumentosByTituloAndAutorAndTipoAndCategoria($titulo: String, $autor: String, $tipoId: ID, $categoriaId: ID) {
          getDocumentosByTituloAndAutorAndTipoAndCategoria(titulo: $titulo, autor: $autor, tipoId: $tipoId, categoriaId: $categoriaId) {
            id
            titulo
            autor
            editorial
            anioSalida
            edicion
            codigo
            tipoDocumento {
              id
              tipo
            }
            categoriaDocumento {
              id
              categoria
            }
          }
        }
        `
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryDocumentos,
            variables: {
              titulo: title,
              autor: aut,
              tipoId: tipo,
              categoriaId: categoria
            }
          }),
          success: function(response){
            response.data.getDocumentosByTituloAndAutorAndTipoAndCategoria.forEach(cardDocumentos)
            document.getElementById("catalogContainer").innerHTML = listCardDocumentos.join("")
            console.log("card agregadas")
            aplicarCambiosCard()
          }
        })
      }

    </script>
<!-- Styles como los del css pero no-->
    <style>
      .hero-section {
        background-color: #f8f9fa;
        padding: 4rem 0;
      }
      .features-section {
        padding: 4rem 0;
      }
      .display-4 {
        font-size: 1000%;
        font-family: "Times New Roman", Times, serif;
      }
      .nav-link {
        align-items: center;
        font-family: "Times New Roman", Times, serif;
        align-content: center;
        text-align: end;
        margin-top: 2%;
      }
      .card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
          transform: scale(1.05);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

    </style>
  </head>
  
  <!-- El cuelpo del diablo -->
  
<body onload="cargarTipoCategoriasDocumentos()">
  <div class="container my-5">
    <h1 class="text-center mb-5">Catálogo de Productos</h1>

    <!-- Barra de búsqueda y filtros -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="searchBarTitle" class="form-control" placeholder="Buscar por Título..." value="" onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()">
        </div>
        <div class="col-md-6 search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="searchBarAuthor" class="form-control" placeholder="Buscar por Autor..." value="" onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()">
        </div>
    </div>
    <div class="row g-3 mb-5">
        <div class="col-md-6">
            <select id="formSelectTipo" class="form-select" onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()">
            </select>
        </div>
        <div class="col-md-6">
            <select id="formSelectCategoria" class="form-select" onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()">
            </select>
        </div>
    </div>

  <div class="container my-5">
    <!-- Contenedor de tarjetas -->
    <div class="row" id="catalogContainer">
      <!-- Ejemplo de tarjeta -->
    </div>
  </div>  
  </div>
  <div class="container">
    <div class="row my-2">
      <button type="button" class="btn btn-primary">Agregar Documento</button>
    </div>
    <div class="row my-2">
      <button type="button" class="btn btn-danger">Eliminar Documento</button>    
    </div>
    <div class="row my-2">
      <button type="button" class="btn btn-primary">Agregar Ejemplar</button>
    </div>
    <div class="row my-2">
      <button type="button" class="btn btn-danger">Eliminar Ejemplar</button>
    </div>
  </div>
<!-- Footer begins here remember to keep your house tidy an you too-->

    <footer class="bg-dark text-light py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-3">
            <h5>Muni Book</h5>
            <ul class="list-unstyled">
              <li>Tu libreria de confianza</li>
              <li>Siguenos en redes!</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Explorar</h5>
            <ul class="list-unstyled">
              <li>Catalogo</li>
              <li>Inicia Sesion</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Recursos</h5>
            <ul class="list-unstyled">
              <li>Sobre nosotros</li>
                           <li>Contactanos</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Siguenos</h5>
            <div class="d-flex">
              <a href="#" class="text-light me-2">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M18 2H15C13.6739 2 12.4021 2.52678 11.4645 3.46447C10.5268 4.40215 10 5.67392 10 7V10H7V14H10V22H14V14H17L18 10H14V7C14 6.73478 14.1054 6.48043 14.2929 6.29289C14.4804 6.10536 14.7348 6 15 6H18V2Z"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
              <a href="#" class="text-light me-2">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M23 3C22.1 3.35 21.2 3.58 20.2 3.69C21.2 3.08 22 2.13 22.4 1C21.5 1.55 20.5 1.95 19.4 2.17C18.5 1.23 17.3 0.67 16 0.67C13.5 0.67 11.5 2.67 11.5 5.17C11.5 5.55 11.5 5.92 11.6 6.27C7.8 6.09 4.3 4.29 2 1.5C1.6 2.22 1.4 3.03 1.4 3.89C1.4 5.5 2.2 6.94 3.4 7.79C2.6 7.77 1.8 7.55 1.1 7.19V7.23C1.1 9.43 2.7 11.28 4.8 11.73C4.4 11.83 4 11.88 3.6 11.88C3.3 11.88 3 11.85 2.7 11.79C3.3 13.61 5 14.92 7 14.96C5.4 16.17 3.4 16.89 1.2 16.89C0.8 16.89 0.4 16.87 0 16.82C2 18.12 4.4 18.87 7 18.87C16 18.87 20.7 11.41 20.7 4.95C20.7 4.75 20.7 4.55 20.7 4.35C21.6 3.67 22.4 2.82 23 1.85V3Z"
                    fill="white"
                  />
                </svg>
              </a>
              <a href="#" class="text-light me-2">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M16 8C17.5913 8 19.1174 8.63214 20.2426 9.75736C21.3679 10.8826 22 12.4087 22 14V21H18V14C18 13.4696 17.7893 12.9609 17.4142 12.5858C17.0391 12.2107 16.5304 12 16 12C15.4696 12 14.9609 12.2107 14.5858 12.5858C14.2107 12.9609 14 13.4696 14 14V21H10V14C10 12.4087 10.6321 10.8826 11.7574 9.75736C12.8826 8.63214 14.4087 8 16 8V8Z"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M6 9H2V21H6V9Z"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M4 6C5.10457 6 6 5.10457 6 4C6 2.89543 5.10457 2 4 2C2.89543 2 2 2.89543 2 4C2 5.10457 2.89543 6 4 6Z"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
              <a href="#" class="text-light">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M17 2H7C4.23858 2 2 4.23858 2 7V17C2 19.7614 4.23858 22 7 22H17C19.7614 22 22 19.7614 22 17V7C22 4.23858 19.7614 2 17 2Z"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
