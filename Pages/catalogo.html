<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="icon" href="/Assets/Icon/book-svgrepo-com.svg" />

    <title>MuniBook</title>

    <script>
      let listaDocumentosAgregados = [];
      let listaCantEjemplaresAgregados = [];
      const objectPrestamos = {
        MapPrestamos: new Map(),
      };

      Object.defineProperty(objectPrestamos, "setter", {
        set: function (input) {
          let idDocumento = input[0];
          let Prestamo = input[1];

          if (this.MapPrestamos.has(idDocumento)) {
            let list = this.MapPrestamos.get(idDocumento);
            list.push(Prestamo);
            this.MapPrestamos.set(idDocumento, list);
          } else {
            this.MapPrestamos.set(idDocumento, [Prestamo]);
          }
          console.log(this.MapPrestamos);
          let list = this.MapPrestamos.get(idDocumento);
          updSolicitudPrestamo(list);
        },
      });

      let usuarioIdGeneral = "";
      // Obtencion de cookies y cambios asociados
      async function aplicarVersionUsuario() {}

      async function ModalGenCheckBox() {
        let buttonContainer = document.getElementById("ModalCheckboxCategoria");
        let strButtons = `
        <li>
        <label class="dropdown-item">
          <input type="checkbox" value="option1"> Opción 1
        </label>
        </li>
      <li>
        <label class="dropdown-item">
          <input type="checkbox" value="option2"> Opción 2
        </label>
      </li>
      <li>
        <label class="dropdown-item">
          <input type="checkbox" value="option3"> Opción 3
        </label>
      </li>
      <li>
        <label class="dropdown-item">
          <input type="checkbox" value="option4"> Opción 4
        </label>
      </li>
        `;
        buttonContainer.innerHTML = strButtons;
      }

      async function aplicarVersionBibliotecario() {
        let buttonContainer = document.getElementById("contaniner-bb-buttons");
        let strButtons = `
        <div class="d-grid gap-2 d-md-flex justify-content-md-center my-4 mx-3">
          <button type="button" class="btn btn-dark btn-rounded" data-bs-toggle="modal"
          data-bs-target="#Agregardoc">Agregar Documento</button>
          <button type="button" class="btn btn-info btn-rounded" data-bs-toggle="modal"
          data-bs-target="#ModalEliminarDocumento">Eliminar Documento</button>   
          <button type="button" class="btn btn-primary" data-bs-toggle="modal"
          data-bs-target="#ModalAgregarEjemplares">Agregar Ejemplar</button>
          <button type="button" class="btn btn-danger" data-bs-toggle="modal"
          data-bs-target="#DelEjemplares">Eliminar Ejemplar</button>
        </div>
        `;
        buttonContainer.innerHTML = strButtons;
      }

      function AddDocumento() {
        let ModalAnioSalida = document.getElementById("ModalAnioSalida").value;
        let ModalAutor = document.getElementById("ModalAutor").value;
        let ModalCategoriaDocumento =
          document.getElementById("TipCategoriaModal");
        let CategoriasHijos = [];
        for (child of ModalCategoriaDocumento.children) {
          for (child2 of child.children) {
            if (child2.checked) {
              CategoriasHijos.push(child2.value);
            }
          }
        }

        let ModalCodigo = document.getElementById("ModalCodigo").value;
        let ModalEdicion = document.getElementById("ModalEdicion").value;
        let ModalEditorial = document.getElementById("ModalEditorial").value;
        //let ModalTipoDocumento = document.getElementById("ModalTipoDocumento").value;
        let ModalTitulo = document.getElementById("ModalTitulo").value;
        let Modal = document.getElementById("Agregardoc");
        let tipo = document.getElementById("ModalformSelectTipo").value;
        console.log(tipo);

        let queryAddDocumento = `
          mutation AddDocumento($input: DocumentoInput) {
          addDocumento(input: $input) {
          body
          descriptionError
          errorCode
          statusCode
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryAddDocumento,
            variables: {
              input: {
                anioSalida: parseInt(ModalAnioSalida, 10),
                autor: ModalAutor,
                categoriaDocumento: CategoriasHijos,
                codigo: ModalCodigo,
                edicion: parseInt(ModalEdicion, 10),
                editorial: ModalEditorial,
                tipoDocumento: tipo,
                titulo: ModalTitulo,
              },
            },
          }),
          success: function (response) {
            console.log("Response:", response);
          },
          error: function (error) {
            console.error("Error:", error);
          },
        });
      }

      async function aplicarVersionNotUsuario() {}

      async function aplicarVersionAdministrador() {}

      function checkCookieExistence(name) {
        console.log(document.cookie);
        if (
          document.cookie
            .split(";")
            .some((item) => item.trim().startsWith(`${name}=`))
        ) {
          let tipoCookie = document.cookie
            .split("; ")
            .find((row) => row.startsWith(`${name}=`))
            ?.split("=")[1];
          let UsuarioIdCookie = document.cookie
            .split("; ")
            .find((row) => row.startsWith(`id=`))
            ?.split("=")[1];

          usuarioIdGeneral = UsuarioIdCookie;

          tipoCookie = parseInt(tipoCookie, 10);

          switch (tipoCookie) {
            case 0:
              console.log("Usuario");
              aplicarVersionUsuario();
              break;
            case 1:
              console.log("Bibliotecario");
              aplicarVersionBibliotecario();
              break;
            case 2:
              console.log("Administrador");
              aplicarVersionAdministrador();

              break;
            /*  
            default:
              aplicarVersionNotUsuario()
              console.log(tipoCookie)
              console.log("NotUsuario")
              */
          }

        } else {
          console.log("NotUsuario");
          aplicarVersionNotUsuario();

        }
      }

      // form select de tipo y categoria

      let optionFormSelectTipo = ['<option value="">Selecciona Tipo</option>'];
      function optionTipo(item) {
        optionFormSelectTipo.push(
          '<option value="' + item.id + '">' + item.tipo + "</option>"
        );

      }

      let optionModalTipoCategoria = [];
      function optionModalCategoria(item) {
        optionModalTipoCategoria.push(
          `<label class="dropdown-item">
                        <input type="checkbox" value="${item.id}" class="me-2"/>
                        ${item.categoria}
                      </label>`
        );
      }

      let optionFormSelectCategoria = [
        '<option value="">Selecciona Categoria</option>',
      ];
      function optionCategoria(item) {
        optionFormSelectCategoria.push(
          '<option value="' + item.id + '">' + item.categoria + "</option>"
        );
      }


      let optionFormSelectDocumento = [
        '<option value="">Selecciona Documento</option>',
      ];
      function optionDocumentos(item) {
        optionFormSelectDocumento.push(
          '<option value="' + item.id + '">' + item.titulo + "</option>"
        );
      }
      // Funciones para optener la lista de tipo y categoria
      async function cargarTipo() {

        let queryTipo = `
        query GetTipoDocumentos {
          getTipoDocumentos {
            id
            tipo
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryTipo,
          }),
          success: function (response) {
            response.data.getTipoDocumentos.forEach(optionTipo);
            document.getElementById("formSelectTipo").innerHTML =
              optionFormSelectTipo.join("");

            document.getElementById("ModalformSelectTipo").innerHTML =
              optionFormSelectTipo.join("");
          },
        });
      }


      async function cargarCategoria() {

        let queryCategoria = `
        query GetCategoriaDocumentos {
          getCategoriaDocumentos {
            id
            categoria
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryCategoria,
          }),
          success: function (response) {
            response.data.getCategoriaDocumentos.forEach(optionCategoria);
            document.getElementById("formSelectCategoria").innerHTML =
              optionFormSelectCategoria.join("");
            response.data.getCategoriaDocumentos.forEach(optionModalCategoria);
            document.getElementById("TipCategoriaModal").innerHTML =
              optionModalTipoCategoria.join("");
          },
        });
      }

      function aplicarCambiosCard() {
        if (
          document.cookie
            .split(";")
            .some((item) => item.trim().startsWith(`tipo=`))
        ) {
          let tipoCookie = document.cookie
            .split("; ")
            .find((row) => row.startsWith(`tipo=`))
            ?.split("=")[1];

          tipoCookie = parseInt(tipoCookie, 10);

          if (tipoCookie == 2) {
            let inputGroupList = document.getElementsByClassName("input-group");
            for (inputGroup of inputGroupList) {
              inputGroup.classList.add("d-none");
            }
          } else if (tipoCookie == 1) {
          } else if (tipoCookie == 0) {
            let collapseList = document.getElementsByClassName("collapse-card");
            for (collapse of collapseList) {
              let idDocumentoCollapse = collapse.id;
              let idDocumento = idDocumentoCollapse.split("-")[0];
              let strButton = `<button type="button" class="btn btn-success" 
              id="${idDocumento}-addButton">
              Agregar a Solicitud</button>
              `;
              collapse.insertAdjacentHTML("beforeend", strButton);

              $(`#${idDocumento}-addButton`).click(function () {
                addPrestamoToSolicitud(idDocumento);
              });
            }
            crearSolicitudInicial();

          }
        }
      }

      function addDays(date, days) {
        var result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      }


      async function addPrestamoToSolicitud(idDocumentoDelBoton) {
        let inputNumberDocumento = document.getElementById(
          `${idDocumentoDelBoton}-input`
        );
        let cantEjemplares = parseInt(inputNumberDocumento.value, 10);
        if (cantEjemplares == 0) {
          let prestamosAnteriores =
            objectPrestamos.MapPrestamos.get(idDocumentoDelBoton);
          prestamosAnteriores.forEach((prestamo) => eliminarPrestamo(prestamo));
          objectPrestamos.MapPrestamos.set(idDocumentoDelBoton, []);
          return;
        }
        if (objectPrestamos.MapPrestamos.has(idDocumentoDelBoton)) {
          let prestamosAnteriores =
            objectPrestamos.MapPrestamos.get(idDocumentoDelBoton);
          prestamosAnteriores.forEach((prestamo) => eliminarPrestamo(prestamo));
          objectPrestamos.MapPrestamos.set(idDocumentoDelBoton, []);
        }
        let arrayEjemplares = await getNEjemplaresByDocumentId(
          idDocumentoDelBoton,
          cantEjemplares
        );
      }

      function eliminarPrestamo(prestamo) {
        let idPrestamo = prestamo.id;
        let queryDelPrestamo = `
        mutation DelPrestamo($delPrestamoId: ID!) {
          delPrestamo(id: $delPrestamoId) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryDelPrestamo,
            variables: {
              delPrestamoId: idPrestamo,
            },
          }),
          success: function (response) {
            console.log("Prestamo eliminado");
          },
        });
      }

      function addPrestamo(ejemplarParametro, idDocumento) {
        let idEjemplar = ejemplarParametro.id;
        let queryAddPrestamo = `
        mutation AddPrestamo($input: PrestamoInput) {
          addPrestamo(input: $input) {
            id
            tipoPrestamo
            fechaPrestamo
            fechaDevolucion
            fechaDevolucionReal
          }
        }
        `;
        // Por default el prestamo sera en sala y la fecha es la actual
        let fechaActual = Date.now();
        let fechaDevolucion = addDays(fechaActual, 7).toISOString();
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryAddPrestamo,
            variables: {
              input: {
                tipoPrestamo: "Sala",
                ejemplar: idEjemplar,
                fechaPrestamo: fechaActual,
                fechaDevolucion: fechaDevolucion,
                fechaDevolucionReal: null,
              },
            },
          }),
          success: function (response) {
            let prestamo = response.data.addPrestamo;
            console.log(idDocumento, prestamo);
            objectPrestamos.setter = [idDocumento, prestamo];
          },
        });
      }

      function getNEjemplaresByDocumentId(idDocumento, cantEjemplares) {
        let queryEjemplares = `
        query GetNEjemplaresDisponiblesByDocumentId($documentoId: ID, $cantEjemplares: Int) {
          getNEjemplaresDisponiblesByDocumentId(documentoId: $documentoId, cantEjemplares: $cantEjemplares) {
            id
            codigo
            estado
            estadoTexto
            ubicacion
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryEjemplares,
            variables: {
              documentoId: idDocumento,
              cantEjemplares: cantEjemplares,
            },
          }),
          success: function (response) {
            let Ejemplares =
              response.data.getNEjemplaresDisponiblesByDocumentId;
            Ejemplares.forEach((item) => addPrestamo(item, idDocumento));
            console.log(Ejemplares);
          },
        });
      }

      async function crearSolicitudInicial() {
        let hasSolicitudCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith(`hasSolicitud=`))
          ?.split("=")[1];
        if (hasSolicitudCookie) {
          return;
        }
        let usuarioId = usuarioIdGeneral;
        let listaPrestamos = [];
        let queryAddSolicitudPrestamo = `
        mutation AddSolicitudPrestamo($addSolicitudPrestamoInput2: SolicitudPrestamoInput) {
          addSolicitudPrestamo(input: $addSolicitudPrestamoInput2) {
            id
            tipoSolicitud
            estadoSolicitud
            fechaSolicitud
          }
        }
        `;
        // Los defaults de la Solicitud
        let fechaActual = Date.now();
        let tipo = "Sala";
        let estado = 0;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryAddSolicitudPrestamo,
            variables: {
              addSolicitudPrestamoInput2: {
                tipoSolicitud: tipo,
                estadoSolicitud: estado,
                fechaSolicitud: fechaActual,
                usuario: usuarioId,
                prestamos: [],
              },
            },
          }),
          success: function (response) {
            let ahora = new Date();
            let tiempo = ahora.getTime();
            let expireTime = tiempo + 900000;
            ahora.setTime(expireTime);
            let solicitud = response.data.addSolicitudPrestamo;
            document.cookie =
              "hasSolicitud=" +
              true +
              ";expires=" +
              ahora.toUTCString +
              "; path=/; SameSite=lax; Secure";
            document.cookie =
              "solicitudID=" +
              solicitud.id +
              ";expires=" +
              ahora.toUTCString +
              "; path=/; SameSite=lax; Secure";
          },
        });
      }

      function updSolicitudPrestamo(listaPrestamos) {
        let idSolicitudCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith(`solicitudID=`))
          ?.split("=")[1];
        let listaIDPrestamos = [];
        for (prestamo of listaPrestamos) {
          listaIDPrestamos.push(prestamo.id);
        }
        console.log(listaIDPrestamos);
        let fechaActual = Date.now();
        let tipo = "Sala";
        let estado = 0;
        let usuarioId = usuarioIdGeneral;
        let queryupdSolicitud = `
        mutation UpdSolicitudPrestamo($updSolicitudPrestamoId: ID!, $updSolicitudPrestamoInput2: SolicitudPrestamoInput) {
          updSolicitudPrestamo(id: $updSolicitudPrestamoId, input: $updSolicitudPrestamoInput2) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryupdSolicitud,
            variables: {
              updSolicitudPrestamoId: idSolicitudCookie,
              updSolicitudPrestamoInput2: {
                tipoSolicitud: tipo,
                estadoSolicitud: estado,
                fechaSolicitud: fechaActual,
                usuario: usuarioId,
                prestamos: listaIDPrestamos,
              },
            },
          }),
          success: function (response) {
            console.log(response);
          },
        });
      }

      let cantEjemplaresDisponible = 0;
      let cantEjemplaresSala = 0;
      // Obtener los ejemplares y crear el inner html
      function getEjemplares(documentoId, estado, estadoTexto) {
        console.log("Obteniendo Ejemplares");
        let queryCantEjemplares = `
        query Query($documentoId: ID!, $estado: Int) {
          getCantEjemplaresByDocumentoAndEstado(documentoId: $documentoId, estado: $estado)
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryCantEjemplares,
            variables: {
              documentoId: documentoId,
              estado: estado,
            },
          }),
          success: function (response) {
            console.log("Ejemplares obtenidos");
            let cant = response.data.getCantEjemplaresByDocumentoAndEstado;
            if (estado == 3) {
              cantEjemplaresDisponible =
                response.data.getCantEjemplaresByDocumentoAndEstado;
              let strInputGroup = `
              <button class="btn btn-outline-secondary btn-number-${documentoId}" type="button" id="${documentoId}-button-minus" documentId="${documentoId}" data-type="minus">-</button>
              <input type="text" class="form-control input-number" value="0" min="0" max="${cantEjemplaresDisponible}" id="${documentoId}-input">
              <button class="btn btn-outline-secondary btn-number-${documentoId}" type="button" id="${documentoId}-button-plus" documentId="${documentoId}" data-type="plus">+</button>
              `;
              document.getElementById(`${documentoId}-inputGroup`).innerHTML =
                strInputGroup;

              $(`.btn-number-${documentoId}`).click(function () {
                let tipo = $(this).attr("data-type");
                let documentId = $(this).attr("documentId");
                let input = $(`#${documentoId}-input`);
                let currentValue = parseInt(input.val());
                if (!isNaN(currentValue)) {
                  if (tipo == "minus") {
                    if (currentValue > input.attr("min")) {
                      input.val(currentValue - 1).change();
                    }
                    if (parseInt(input.val()) == input.attr("min")) {
                      $(this).attr("disabled", false);
                    }
                  } else {
                    if (currentValue < input.attr("max")) {
                      input.val(currentValue + 1).change();
                    }
                    if (parseInt(input.val()) == input.attr("max")) {
                      $(this).attr("disabled", false);
                    }
                  }
                } else {
                  input.val(0);
                }
              });
            }
            if (estado == 2) {
              cantEjemplaresSala =
                response.data.getCantEjemplaresByDocumentoAndEstado;
            }

            let elementoCantEjemplares = document.getElementById(
              `${documentoId}.${estadoTexto}`
            );
            elementoCantEjemplares.innerHTML = `${estadoTexto}: ${cant}`;
            elementoCantEjemplares.setAttribute("valor", cant);
          },
        });
      }

      // Definir la card para cada elemento del catalogo, obteniendo los ejemplares y preparando la informacion
      let listCardDocumentos = [];
      function cardDocumentos(item) {
        let listCategoriaDocumentosId = [];
        let listCategoriaDocumentosNombre = [];

        for (categoria of item.categoriaDocumento) {
          listCategoriaDocumentosId.push(categoria.id);
          listCategoriaDocumentosNombre.push(categoria.categoria);
        }

        getEjemplares(item.id, 3, "Disponible");
        getEjemplares(item.id, 2, "En Sala");

        let stringCard = `
        <div class="col-md-4 mb-4">
          <div class="card border-secondary mb-3" id=${
            item.id
          } categoria=${listCategoriaDocumentosId} tipoDocumento=${
          item.tipoDocumento.id
        }>
              <div class="card-body" id=${item.id}>
                <h5 class="card-title">${item.titulo}</h5>
                <p class="card-text" id="card-text" autor="${
                  item.autor
                }" tipoDocumento="${item.tipoDocumento.tipo}">${item.autor}, ${
          item.anioSalida
        }, ${item.editorial}, ${item.tipoDocumento.tipo},</p>
                <div class="d-flex justify-content-center">
                  <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#${
                    item.id
                  }-collapse">
                    Ver más información
                  </button>
                </div>
                <div class="collapse collapse-card" id="${item.id}-collapse">
                  <div class="container my-3">
                    <p class="card-text my-1">${item.edicion}a Edición</p>
                    <p class="card-text my-1">Categorias: ${listCategoriaDocumentosNombre.toString()}</p>
                    <p class="card-text my-1" id="${
                      item.id
                    }.Disponible">Disponible: </p>
                    <p class="card-text my-1" id="${item.id}.En Sala">Sala: </p>
                    <div class="input-group my-1" id="${item.id}-inputGroup">
                      
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
        `;
        listCardDocumentos.push(stringCard);
      }

      // Cargar documentos inicial
      async function cargarDocumentos() {

        let queryDocumentos = `
        query GetNDocumentos($numero: Int) {
          getNDocumentos(numero: $numero) {
            id
            titulo
            autor
            editorial
            anioSalida
            edicion
            codigo
            tipoDocumento {
              id
              tipo
            }
            categoriaDocumento {
              id
              categoria
            }
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryDocumentos,
            variables: {
              numero: 100,
            },
          }),

          success: function (response) {
            response.data.getNDocumentos.forEach(cardDocumentos);
            document.getElementById("catalogContainer").innerHTML =
              listCardDocumentos.join("");
            console.log("card agregadas");
            aplicarCambiosCard();
            response.data.getNDocumentos.forEach(optionDocumentos);
            document.getElementById("ModalDocumentoEjemplar").innerHTML =
              optionFormSelectDocumento.join("");
          },
        });
      }
      // Llamar todas las cosas
      function cargarTipoCategoriasDocumentosAndCookie() {
        cargarTipo();
        cargarCategoria();
        cargarDocumentos();
        checkCookieExistence("tipo");
      }

      // La funcion para el query con los filtros
      function getDocumentosByTituloAndAutorAndTipoAndCategoria() {
        listCardDocumentos = [];
        let title = document.getElementById("searchBarTitle").value;
        let aut = document.getElementById("searchBarAuthor").value;
        let tipo = document.getElementById("formSelectTipo").value;
        let categoria = document.getElementById("formSelectCategoria").value;


        }
        if (categoria == "") {
          categoria = null;
        }
        console.log(title, aut, tipo, categoria);

        let queryDocumentos = `
        query GetDocumentosByTituloAndAutorAndTipoAndCategoria($titulo: String, $autor: String, $tipoId: ID, $categoriaId: ID) {
          getDocumentosByTituloAndAutorAndTipoAndCategoria(titulo: $titulo, autor: $autor, tipoId: $tipoId, categoriaId: $categoriaId) {
            id
            titulo
            autor
            editorial
            anioSalida
            edicion
            codigo
            tipoDocumento {
              id
              tipo
            }
            categoriaDocumento {
              id
              categoria
            }
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: queryDocumentos,
            variables: {
              titulo: title,
              autor: aut,
              tipoId: tipo,
              categoriaId: categoria,
            },
          }),

          success: function (response) {
            response.data.getDocumentosByTituloAndAutorAndTipoAndCategoria.forEach(
              cardDocumentos
            );
            document.getElementById("catalogContainer").innerHTML =
              listCardDocumentos.join("");
            console.log("card agregadas");
            aplicarCambiosCard();
          },
        });

      function agregarEjemplar() {
        let codigo = document.getElementById("ModalCodigoEjemplar").value;
        let ubicacion = document.getElementById("ModalUbicaionEjemplar").value;
        let idDocumento = document.getElementById(
          "ModalDocumentoEjemplar"
        ).value;
        console.log(codigo, ubicacion, idDocumento);
        let querySignIn = `
        mutation AddEjemplar($input: EjemplarInput) {
          addEjemplar(input: $input) {
            body
            descriptionError
            errorCode
            statusCode
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: querySignIn,
            variables: {
              input: {
                codigo: codigo,
                documento: idDocumento,
                estado: 3,
                estadoTexto: "Disponible",
                ubicacion: ubicacion,
              },
            },
          }),
          success: function (response) {
            console.log("Response:", response);
          },
          error: function (error) {
            console.error("Error:", error);
          },
        });
      }

      function eliminarDocumento() {
        let codigo = document.getElementById("ModalCodigoEliminar").value;
        console.log(codigo);
        let querySignIn = `
        mutation DelDocumento($delDocumentoId: ID!) {
          delDocumento(id: $delDocumentoId) {
            body
            descriptionError
            errorCode
            statusCode
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: querySignIn,
            variables: {
              delDocumentoId: codigo,
            },
          }),
          success: function (response) {
            console.log("Response:", response);
          },
          error: function (error) {
            console.error("Error:", error);
          },
        });
      }

      function eliminarEjemplar() {
        let codigo = document.getElementById("ModalejemplarCode").value;
        console.log(codigo);
        let querySignIn = `
        mutation DelEjemplar($delEjemplarId: ID!) {
          delEjemplar(id: $delEjemplarId) {
            statusCode
            body
            errorCode
            descriptionError
          }
        }
        `;
        $.ajax({
          type: "POST",
          url: "http://localhost:8092/graphql",
          contentType: "application/json",
          timeout: 15000,
          data: JSON.stringify({
            query: querySignIn,
            variables: {
              delEjemplarId: codigo,
            },
          }),
          success: function (response) {
            console.log("hoal:");
          },
          error: function (error) {
            console.error("chao:");
          },
        });

      }
    </script>

    <!-- Styles como los del css pero no-->

    <style>
      .enlarge-modal {
        min-width: 1600px;
        width: 900px;
      }
      .hero-section {
        background-color: #f8f9fa;
        padding: 4rem 0;
      }
      h1 {
        font-family: "Times New Roman", Times, serif;
        font-size: 2rem;
        font-weight: 500;
        font-size: 400%;
      }

      .letra-main {
        font-family: "Times New Roman", Times, serif;
      }

      .features-section {
        padding: 4rem 0;
      }
      .display-4 {
        font-size: 1000%;
        font-family: "Times New Roman", Times, serif;
      }
      .nav-link {
        align-items: center;
        font-family: "Times New Roman", Times, serif;
        align-content: center;
        text-align: end;
        margin-top: 2%;
      }
      .card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);

      }

      body {
        font-family: "Times New Roman", Times, serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .container {
        flex: 1;
      }

      .cat-button {
        width: 200px;
      }

      .dropdown-menu {
        min-width: 300px;
      }

      .dropdown-check {
        color: #ec1010;
      }

      footer {
        text-align: left;
      }

      .footer-link {
        color: inherit;
        text-decoration: none;
        cursor: pointer;
      }

      .footer-link:hover {
        text-decoration: underline;
        color: inherit;
      }

      .btn-custom-width {
        width: auto;
        min-width: 400px; /* Ajusta según el tamaño que desees para que no se estiren */
        padding: 0.5rem 1rem; /* Espaciado interno para darle un aspecto más compacto */
      }

      .scrollable-menu {
        height: auto;
        max-height: 200px;
        overflow-x: hidden;
      }
    </style>
  </head>

  <!-- El cuelpo del diablo -->

  <body onload="cargarTipoCategoriasDocumentosAndCookie()">
    <nav
      class="navbar navbar-expand-lg navbar-light bg-light"
      id="navbar-catalogo"
    >
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <svg
            width="30"
            height="30"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect width="24" height="24" fill="white" />
            <path d="M4 4H20V20H4V4Z" stroke="black" stroke-width="2" />
            <path d="M8 8H16V16H8V8Z" stroke="black" stroke-width="2" />
          </svg>
        </a>
        <!-- Botones del navbar-->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#contact">Contacto</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="catalogo.html">Catalogo</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="#servicios">Servicios</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container my-5">
      <h1 class="text-center mb-5">Catálogo de Productos</h1>


      <!-- Barra de búsqueda y filtros -->
      <div class="row g-3 mb-4">
        <div class="col-md-6 search-bar">
          <i class="bi bi-search"></i>
          <input
            type="text"
            id="searchBarTitle"
            class="form-control"
            placeholder="Buscar por Título..."
            value=""
            onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()"
          />
        </div>
        <div class="col-md-6 search-bar">
          <i class="bi bi-search"></i>
          <input
            type="text"
            id="searchBarAuthor"
            class="form-control"
            placeholder="Buscar por Autor..."
            value=""
            onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()"
          />
        </div>
      </div>
      <div class="row g-3 mb-5">
        <div class="col-md-6">
          <select
            id="formSelectTipo"
            class="form-select"
            onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()"
          ></select>
        </div>
        <div class="col-md-6">
          <select
            id="formSelectCategoria"
            class="form-select"
            onchange="getDocumentosByTituloAndAutorAndTipoAndCategoria()"
          ></select>
        </div>
        <div class="container" id="contaniner-bb-buttons"></div>
      </div>
    </div>
    <div class="container my-5">
      <!-- Contenedor de tarjetas -->
      <div class="row" id="catalogContainer">
        <!-- Ejemplo de tarjeta -->
      </div>
    </div>
    <!-- Modal Agregar Documentos -->
    <div
      class="modal fade"
      id="Agregardoc"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
              Agregar Documento
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <!-- Titulo -->
              <div class="mb-3">
                <label for="ModalTitulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="ModalTitulo" />
              </div>

              <!-- Autor -->
              <div class="mb-3">
                <label for="ModalAutor" class="form-label">Autor</label>
                <input type="text" class="form-control" id="ModalAutor" />
              </div>

              <div class="row">
                <!-- Año Salida -->
                <div class="col-md-4 mb-3">
                  <label for="ModalAnioSalida" class="form-label"
                    >Año Salida</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="ModalAnioSalida"
                  />
                </div>
                <!-- Edición -->
                <div class="col-md-4 mb-3">
                  <label for="ModalEdicion" class="form-label">Edición</label>
                  <input type="text" class="form-control" id="ModalEdicion" />
                </div>
                <!-- Editorial -->
                <div class="col-md-4 mb-3">
                  <label for="ModalEditorial" class="form-label"
                    >Editorial</label
                  >
                  <input type="text" class="form-control" id="ModalEditorial" />
                </div>
              </div>
              <!-- Código -->
              <div class="mb-3">
                <label for="ModalCodigo" class="form-label">Código</label>
                <input
                  type="text"
                  class="form-control"
                  id="ModalCodigo"
                  aria-describedby="emailHelp"
                />
              </div>
              <div class="row">
                <!-- Categoría (Multiselect jerárquico) -->
                <div class="col-md-6 mb-3">
                  <label for="multiSelect" class="form-label">Categoría</label>
                  <div class="dropdown">
                    <button
                      class="btn btn-outline-secondary dropdown-toggle cat-button"
                      type="button"
                      id="multiSelectDropdown"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                    >
                      Seleccionar
                    </button>
                    <div
                      class="dropdown-menu p-2 scrollable-menu"
                      aria-labelledby="multiSelectDropdown"
                      id="TipCategoriaModal"
                    ></div>
                  </div>
                  <div class="mt-2">
                    <span id="selectedCategories" class="dropdown-check"
                      >No se han seleccionado categorías.</span
                    >
                  </div>
                </div>
                <!-- Tipo Documento -->
                <div class="col-md-6 mb-3">
                  <label for="ModalformSelectTipo" class="form-label"
                    >Documento</label
                  >
                  <select id="ModalformSelectTipo" class="form-select"></select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="AddDocumento()"
            >
              Agregar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Agregar Ejemplares -->

    <div class="modal fade" id="ModalAgregarEjemplares" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Ejemplares</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form action="">
              <div class="mb-3">
                <label for="exampleInputEmail1" class="form-label"
                  >Codigo Ejemplar</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ModalCodigoEjemplar"
                  aria-describedby="emailHelp"
                />
              </div>
              <div class="mb-3">
                <select
                  class="form-select"
                  id="ModalDocumentoEjemplar"
                ></select>
              </div>
              <div class="mb-3">
                <label for="exampleInputEmail1" class="form-label"
                  >Ubicacion</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ModalUbicaionEjemplar"
                  aria-describedby="emailHelp"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="agregarEjemplar()"
            >
              Agregar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Eliminar Documento elimina por la id del ejemplar -->

    <!-- Primer Modal -->
    <div class="modal fade" id="ModalEliminarDocumento" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar Documento</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="ModalCodigoEliminar" class="form-label"
                  >Código Documento</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ModalCodigoEliminar"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <!-- Botón que muestra el segundo modal -->
            <button
              type="button"
              class="btn btn-primary"
              data-bs-target="#ModalConfirmarEliminar"
              data-bs-toggle="modal"
              data-bs-dismiss="modal"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Segundo Modal (Confirmación) -->
    <div class="modal fade" id="ModalConfirmarEliminar" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmación</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>¿Estás seguro de que quieres eliminar este documento?</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="eliminarDocumento()"
            >
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--modal de eliminar ejemplar-->
    <!-- Primer Modal -->
    <div class="modal fade" id="DelEjemplares" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar Ejemplar</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="ModalejemplarCode" class="form-label"
                  >Id del Ejemplar</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="ModalejemplarCode"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <!-- Botón que muestra el segundo modal -->
            <button
              type="button"
              class="btn btn-primary"
              data-bs-target="#ModalConfirmarEjemplar"
              data-bs-toggle="modal"
              data-bs-dismiss="modal"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Segundo Modal (Confirmación) -->
    <div class="modal fade" id="ModalConfirmarEjemplar" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmación</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>¿Estás seguro de que quieres eliminar este id de ejemplar?</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="eliminarEjemplar()"
            >
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer begins here remember to keep your house tidy an you too-->


    <footer class="bg-dark text-light py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-3">
            <h5>Muni Book</h5>
            <ul class="list-unstyled">
              <li>Tu libreria de confianza</li>
              <li>Siguenos en redes!</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Explorar</h5>
            <ul class="list-unstyled">
              <li>
                <a class="footer-link" href="catalogo.html"> Catalogo </a>
              </li>
              <a onclick="loginButton()">Inicia Sesion</a>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Recursos</h5>
            <ul class="list-unstyled">
              <li>Sobre nosotros</li>
              <li>Contactanos</li>
              <li>Atencion al cliente</li>
            </ul>
          </div>
          <div class="col-md-3 mb-3">
            <h5>Siguenos</h5>
            <div class="d-flex">
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-instagram"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-facebook"></i>
              </a>
              <a href="#" class="text-light me-2">
                <i class="fa-brands fa-x-twitter"></i>
              </a>
              <a href="#" class="text-light">
                <i class="fa-brands fa-youtube"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
